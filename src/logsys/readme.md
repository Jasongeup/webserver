# logsys

定义了webServer的日志系统，支持同步、异步写日志，按天分类，支持一天多个日志文件，自动扩充，主要包括了Log、BlockQueue类



## BlockDeque类

### 功能

实现了阻塞队列，主要被Log类调用，用于异步写日志（一条日志消息从写缓冲区中插入到队列中，队列的一个元素就是一条消息string，而整个写缓冲区是只能暂存一条消息）

- 基于STL的双端队列容器，STL::deque是非阻塞的，即如果取空队列的元素会立即返回错误，而且其也没有容量限制，可以一直插入

- 阻塞队列则利用条件变量实现了往空队列中取元素时，会阻塞使用了pop的线程，直到被消费者变量唤醒；定义了最大容量，往一个满队列中插入时也会阻塞，直到被生产者变量唤醒
- 阻塞队列还加入了```unique_lock``互斥锁确保线程安全



### 参数

其接受一个参数指定队列最大容量，其重要3成员有deque<T>，生产者条件变量，消费者条件变量，访问队列的互斥锁mutex



### 代码逻辑

主要成员函数都是模拟了deque的API，只不过增加了阻塞

- 往队列头/尾中插入元素，首先给访问队列互斥锁加锁，当队列满时，等待条件变量，否则插入元素，条件变量通知一个消费者线程
- 队头元素出队，首先给访问队列互斥锁加锁，如果队列是空，则等待条件变量，否则队头元素出队，条件变量通知生产者线程



## Log类

### 功能

实现webserver的日志系统，Log类使用单例懒汉模式，按天记录日志，当天日志满时自动生成新日志文件，用于各种需要日志输出的场景，支持同步写模式/异步写模式

- 基于阻塞队列实现了异步写日志，日志消息的流向为缓冲区—阻塞队列—日志文件
- 实现了同步写模式，日志消息的流向为缓冲区—日志文件



### 参数

初始化日志类单例对象时，接受参数包括，日志级别，日志目录路径，日志文件后缀，最大阻塞队列容量（指BlockQueue的最大容量），重要成员有今天是第几天、一个日志文件最大行数、日志写缓冲区、是否异步写、日志文件的相对路径、写日志线程、互斥锁、指向BlockDeque类的智能指针，其类型为```unique_ptr<BlockDeque<std::string>> deque```；初始化时会获取当天的年月日给文件命名，并创建日志文件，如果是异步写模式，还会初始化一个暂存日志消息的阻塞队列，以及一个写线程



### 代码逻辑

- 定义了一些宏函数，用于写日志包括

  - LOG_DEBUG
  - LOG_INFO
  - LOG_WARN
  - LOG_ERROR

  这些宏函数都接受一个格式化输出字符串，和可变参数...作为消息, 函数则是调用LOG_BASE，获取Log单例对象,将对应的消息输出到日志中

- 写日志函数，首先获取当前的系统时间，再转换成年月日形式，用参数列表获取可变参数，判断要不要新建日志文件（当前日志文件路径不是今天，或者当前文件已经写满），之后先往缓冲区中写入时间，更新写缓冲区指针；再写入日志级别；之后再把消息写入到缓冲区中，更新缓冲区写指针，再把换行符插入缓冲区，此时一条日志消息即生成完毕
- 如果是同步写模式，直接将缓冲区中的所有字符写入日志文件
- 如果是异步写模式，缓冲区所有字符变成一个string对象，插入到阻塞队列中，由写日志线程来完成日志写
- Log对象初始化时建立的写线程运行一个刷新函数，该刷新函数会循环让队列所有元素出队，每个元素出队时，用互斥锁确保日志文件的互斥访问，再把队头元素写入到文件中，实现异步写入



