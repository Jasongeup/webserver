# pool

半同步/半反应堆线程池的实现、数据库连接池的实现，包括SqlConnRAII, SqlConnPool, threadPool三类



## ThreadPool类

### 功能

实现了半同步半反应堆线程池，主要被WebServer类调用，实现http请求处理的高并发模式

- 使用了互斥锁确保线程对任务队列的互斥访问，使用了条件变量实现任务队列与线程的同步
- 使用queue容器实现任务队列，使用function函数符来定义模板参数
- 使用shared_ptr指向线程池对象，使线程池对象可以被多个子线程使用，而且自动析构



### 参数

在类内定义了Pool类, 包含互斥锁、条件变量、任务队列，任务队列基于queue实现，以function<void()>作为元素类型

其接受线程数量为参数，构造对象时初始化一个共享智能指针成员，指向申请的Pool类内存



### 代码逻辑

- 在构造ThreadPool类对象时，会创建多个线程，每个线程中运行一个lambda函数，该函数捕获对象的pool_成员，其首先创建访问线程池队列的互斥锁并加锁，循环访问任务队列：
  - 如果队列非空，取出队头元素并解锁，运行任务
  - 如果队列为空，则等待条件变量
  - 如果要关闭线程池，则退出

- 将线程都设置为脱离线程
- 当要执行读、写连接socket时，WebServer对象将任务插入到请求队列，利用条件变量通知线程
- 销毁线程池时，主要是通过条件变量通知各线程关闭，而线程池Pool类对象被定义为智能指针，会自动析构



## SqlConnRAII类

### 功能

对一个数据库连接的封装，使数据库连接符合RAII特性，主要被HttpRequest调用

- 类对象构造时从数据库连接池中申请一个数据库连接
- 类对象析构时释放该数据库连接回到连接池



### 参数

接受数据库连接池、sql连接指针作为参数，对象构造时获取一个数据库连接赋给该连接指针（之后在HttpRequest中被使用）



### 代码逻辑

只有构造函数与析构函数



## SqlConnPool类

### 功能

数据库连接池，使用单例懒汉模式，主要被SqlConnRAII类调用

- 使用lock_guard来实现对连接池队列的互斥访问
- 使用信号量来实现同步
- 类似生产者（插入空闲的数据库连接）、消费者（取出数据库连接）问题



### 参数

该类单例对象初始化时接受数据库相关参数（主机名、端口、用户名、用户密码、数据库名）、数据库连接池大小，重要成员包括用queue实现的队列、互斥锁、信号量代表空闲的数据库连接数量



### 代码逻辑

- 在对象初始化时会往队列成员中插入多个连接数据库，并初始化信号量
- 要取出一个数据库连接时，先检查信号量，有空闲的数据库连接时，减少信号量，访问队列加锁，取队列头元素返回
- 要回收一个数据库时，访问队列加锁，往队列中插入一个数据库连接，增加信号量
- 关闭连接池时，要逐个出队数据库连接并关闭之
