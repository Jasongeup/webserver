# server

定义了webServer的主要逻辑，是服务器最上层的接口，包含了WebServer类以及Epoller类



## WebServer类

### 功能

WebServer类对象运行在服务器的主线程，其负责初始化服务器的系统组件，监听客户连接以及接受连接，当有客户数据到来或者有数据发送时，就把任务插入到线程池的任务队列中，所以使用了Recator的事件处理模式。

- 使用线程池实现并发
- 使用数据库连接池确保快速访问数据库
- 实现了同步/异步日志系统
- 定时器处理非活动连接



### 参数

其接受一系列服务器参数，包括：

- 端口，触发模式(ET/LT)，定时时间timeoutMs, 是否优雅关闭连接，

- 数据库端口，数据库用户名，数据库密码，数据库名称

- 连接池的数量，线程池数量

- 日志开关，日志等级，日志异步队列容量

创建一个类对象时，初始化资源包括数据库连接池单例对象、线程池单例对象、定时时间堆、epoller类、日志类单例对象



### 代码逻辑

WebServer对象负责创建监听socket，循环监听epoll事件，每次监听之前要检查定时器事件堆，是否有超时连接，当有事件到来时：

- 如果是有新客户连接，则接受所有连接（ET模式），添加该连接socket的监听事件，分配逻辑处理对象，分配定时器
- 如果是连接socket的读就绪事件，则把对应的逻辑处理单元HttpConn插入到线程池的任务处理队列，由其完成从socket上读数据并处理数据、以及写http应答报文、注册写就绪监听事件
- 如果是连接socket的写就绪事件，则把对应的逻辑处理单元插入到线程池的任务处理队列，由其完成往socket上写数据
- 如果是对端关闭连接，则关闭该连接



## Epoller类

### 功能

Epoller类是对epoll表的封装，负责创建、删除、添加、检测epoll表注册事件，主要被webServer类调用，管理socket的I/O事件



### 参数

接受一个指定最大监听事件数目的参数，创建一个类对象时，会创建一个epoll表



### 代码逻辑

基本操作与epoll系统调用类似，只不过封装了创建epoll_event的过程，类成员通过直接输入socket地址、监听事件，就可以操作响应的epoll表的注册事件。

